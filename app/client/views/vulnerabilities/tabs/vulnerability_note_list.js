// Copyright (c) 2014 Tom Steele, Dan Kottmann, FishNet Security
// See the file license.txt for copying permission

Template.vulnerabilityNoteList.notes = function() {
  var vulnerability = Vulnerabilities.findOne(Session.get('vulnerabilityId'));
  if (!vulnerability) {
    return false;
  }
  return vulnerability.notes.sort(sortTitle);
};

Template.vulnerabilityNoteList.note = function() {
  if (Session.equals('noteTitle', null)) {
    return false;
  }
  var vulnerability = Vulnerabilities.findOne(Session.get('vulnerabilityId'));
  if (!vulnerability) {
    return false;
  }
  return vulnerability.notes[_.indexOf(_.pluck(vulnerability.notes, 'title'), Session.get('noteTitle'))];
};


Template.vulnerabilityNoteList.events({
  'submit form': function(event, tpl) {
    event.preventDefault();
    var projectId = Session.get('projectId');
    var vulnerabilityId = Session.get('vulnerabilityId');
    var content = '';
    if (Session.equals('noteTitle', null)) {
      var title = tpl.find('[name=title]').value;
      content = tpl.find('[name=content]').value;
      Meteor.call('addVulnerabilityNote', Session.get('projectId'), Session.get('vulnerabilityId'), title, content, function(err) {
        if (err) {
          return Alerts.insert({"class": "alert-error", "strong": "Error", "message": err.reason});
        }
        Alerts.insert({"class": "alert-success", "strong": "Success", "message": "Note saved"});
        return Session.set('noteTitle', title);
      });
    }
    else {
      content = tpl.find('[name=content]').value;
      Meteor.call('setVulnerabilityNoteContent', projectId, vulnerabilityId, Session.get('noteTitle'), content, function(err){
        if (err) {
          return Alerts.insert({"class": "alert-error", "strong": "Error", "message": err.reason});
        }
        return  Alerts.insert({"class": "alert-success", "strong": "Success", "message": "Note saved"});
      });
    }
  },

  'click .vulnerability-note': function() {
    return Session.set('noteTitle', this.title);
  },

  'click #new-note': function() {
    return Session.set('noteTitle', null);
  },

  'click #remove-notes': function() {
    var projectId = Session.get('projectId');
    var vulnerabilityId = Session.get('vulnerabilityId');
    var noteIds = [];
    var inputs = $('.note-checked');
    inputs.each(function(){
      if ($(this).is(':checked')) {
        noteIds.push($(this).attr('id'));
      }
    });
    noteIds.forEach(function(id) {
      Meteor.call('removeVulnerabilityNote', projectId, vulnerabilityId, id);
    });
  }
});
